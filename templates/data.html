{% extends 'base.html' %}
{% load static %}
{% block title %}Game Data{% endblock %}
{% block content %}

{% comment %}
page so researchers can view data on games
{% endcomment %}

<style>
    /* styling for all buttons and when you expand it. I'll move it into home.css later */
    .button {
        color: white;
        background-color: #e0ac1c;
        font-size: 16px;
        cursor: pointer;
        margin: 5px;
        padding: 10px;
        border-radius: 10px;
        width: 80%;
        text-align: left;
        overflow: hidden;
        white-space: nowrap;
        border: none;
        text-overflow: ellipsis;
    }

    .button:hover { 
        color: white;
        background-color: black;
    }

    .button-expanded {
        background-color: #4d4d4d;
        color: white;
        border-radius: 10px;
        border: 2px solid #e0ac1c;
        padding: 20px;
        width: 80%;
        
    }

    .button-expanded p {
        margin: 0;
    }

    .experiment-row {
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        
    }

    .experiment-info {
        border-radius: 10px;
        border: 2px solid #e0ac1c;
        background-color: #2e2e2e;
        margin-top: 5px;
        padding: 10px;
        width: 80%;
        margin: 5px;
    }

    .experiment-description {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
    }
</style>

<div><p>click an experiment to see further information</p></div>

{% if experiments %}
<div id="viewConditions">
    {% for experiment in experiments %}
    <div class="experiment-row">
        <button class="button" id="experiment_{{experiment}}" 
            onclick="toggleExperiment('{{experiment}}')">
            {{ experiment }}
        </button>
        <div class="experiment-info" id="experiment_info_{{experiment}}" style="display: none;">
            <p class="experiment-description">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
                Proin sodales dui vel quam efficitur, sit amet bibendum dolor iaculis. 
                In hac habitasse platea dictumst. Sed consectetur turpis nec augue molestie, 
                vel ullamcorper mauris eleifend. Vivamus et est vel neque molestie eleifend.
            </p>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
    // This function toggles the visibility of the experiment information associated with the clicked button.
    function toggleExperiment(id) {
        var experimentButton = document.getElementById("experiment_" + id);
        var experimentInfo = document.getElementById("experiment_info_" + id);
        if (experimentButton.classList.contains("button-expanded")) {
            experimentButton.classList.remove("button-expanded");
            experimentInfo.style.display = "none";
        } 
        else {
            experimentButton.classList.add("button-expanded");
            experimentInfo.style.display = "block";
        }
    }
</script>

{% endblock %}

{% block javascript %}
<script>
var current_researcher = "{{ researcher.researcher_id }}"
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
	return cookieValue;
}
//some ajax
// I hate this works but needs some heavy additions
function viewConditions(experiment_name){
	$.ajax({
        type: 'POST',
        url: "{% url 'view_conditions' %}",
        data: {"experiment_name":experiment_name, "current_researcher": current_researcher},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var conditions = response["conditions"]
				// convert to JSON object
				var instance = JSON.parse(conditions);
				var id = "conditions_"+experiment_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
                    `<button id = "condition_${fields["name"]}" value="${fields["name"]}" onclick="viewGames('${fields["name"]}', '${experiment_name}')">${fields["name"]}</button><br>
					<div id = "games_${fields["name"]}_${experiment_name}"></div>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};

function viewGames(condition_name, experiment_name){
    /* You need to make it so the researcher cannot click the button again, or you make it so the researcher can
    click the button again to remove the elements that were just added, do the same for the other button events.
    To remove and add different onclick events using jquery use something like
    $('#id').unbind('click'); -- to remove the event, you can also directly change the attribute of the element if you have the id (which we do)
    $('#id').click(function(){ -- to add a click event
    // your code here
    });
    */
	$.ajax({
        type: 'POST',
        url: "{% url 'view_games' %}",
        data: {"condition_name":condition_name,"experiment_name":experiment_name, "current_researcher":current_researcher},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var games = response["games"]
				// convert to JSON object
				var instance = JSON.parse(games);
				var id = "games_"+condition_name+"_"+experiment_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
					// ADD ONCLICK EVENT FOR CHATS/PLAYERS
                    `<button id = "game_${fields["room_name"]}" value="${fields["room_name"]}" onclick="viewChats('${fields["room_name"]}')">${fields["room_name"]}</button><br>
					<div id = "chats_${fields["room_name"]}"></div>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
function viewChats(room_name){
	$.ajax({
        type: 'POST',
        url: "{% url 'view_chats' %}",
        data: {"room_name":room_name},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var chats = response["chats"]
				// convert to JSON object
				var instance = JSON.parse(chats);
				var id = "chats_"+room_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
                    `<p>${fields["role"]}: ${fields["content"]} -- ${fields["created"]}</p><br>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
// frontend -> need to have a nice way to view all the data for each entry
</script>
{% endblock javascript %}