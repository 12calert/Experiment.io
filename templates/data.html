{% extends 'base.html' %}
{% load static %}
{% block title %}Game Data{% endblock %}
{% block content %}

{% comment %}
page so researchers can view data on games
{% endcomment %}

<div><p>click an experiment to see further information</p></div>

{# needs to change from form to something else #}
{% if experiments %}
<div id = "viewConditions">
    {% csrf_token %}
	{% for experiment in experiments %}
    	<button id = "experiment" value = "{{ experiment }}" onclick = "viewConditions('{{experiment}}')">{{ experiment }}</button>
		{# figure something out here I hate this#}
		<div id = "conditions_{{experiment}}">
		</div>
	{% endfor %}

	
</div>
{% endif %}

{% endblock content %}

{% block javascript %}
<script>
var current_researcher = "{{ researcher.researcher_id }}"
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
	return cookieValue;
}
//some ajax
// I hate this works but needs some heavy additions
function viewConditions(experiment_name){
	$.ajax({
        type: 'POST',
        url: "{% url 'view_conditions' %}",
        data: {"experiment_name":experiment_name, "current_researcher": current_researcher},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var conditions = response["conditions"]
				// convert to JSON object
				var instance = JSON.parse(conditions);
				var id = "conditions_"+experiment_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
                    `<button id = "condition_${fields["name"]}" value="${fields["name"]}" onclick="viewGames('${fields["name"]}', '${experiment_name}')">${fields["name"]}</button><br>
					<div id = "games_${fields["name"]}_${experiment_name}"></div>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};

function viewGames(condition_name, experiment_name){
    /* You need to make it so the researcher cannot click the button again, or you make it so the researcher can
    click the button again to remove the elements that were just added, do the same for the other button events.
    To remove and add different onclick events using jquery use something like
    $('#id').unbind('click'); -- to remove the event, you can also directly change the attribute of the element if you have the id (which we do)
    $('#id').click(function(){ -- to add a click event
    // your code here
    });
    */
	$.ajax({
        type: 'POST',
        url: "{% url 'view_games' %}",
        data: {"condition_name":condition_name,"experiment_name":experiment_name, "current_researcher":current_researcher},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var games = response["games"]
				// convert to JSON object
				var instance = JSON.parse(games);
				var id = "games_"+condition_name+"_"+experiment_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
					// ADD ONCLICK EVENT FOR CHATS/PLAYERS
                    `<button id = "game_${fields["room_name"]}" value="${fields["room_name"]}" onclick="viewChats('${fields["room_name"]}')">${fields["room_name"]}</button><br>
					<div id = "chats_${fields["room_name"]}"></div>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
function viewChats(room_name){
	$.ajax({
        type: 'POST',
        url: "{% url 'view_chats' %}",
        data: {"room_name":room_name},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var chats = response["chats"]
				// convert to JSON object
				var instance = JSON.parse(chats);
				var id = "chats_"+room_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
                    `<p>${fields["role"]}: ${fields["content"]} -- ${fields["created"]}</p><br>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
// frontend -> need to have a nice way to view all the data for each entry
</script>
{% endblock javascript %}