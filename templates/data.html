{% extends 'base.html' %}
{% load static %}
{% block title %}Game Data{% endblock %}
{% block content %}

{% comment %}
page so researchers can view data on games
{% endcomment %}

<div><p>click an experiment to see further information</p></div>

{# needs to change from form to something else #}
{% if experiments %}
<div id = "viewConditions">
    {% csrf_token %}
	{% for experiment in experiments %}
    	<button id = "experiment" value = "{{ experiment }}" onclick = "viewConditions('{{experiment}}')">{{ experiment }}</button>
		{# figure something out here I hate this#}
		<div id = "conditions_{{experiment}}">
		</div>
	{% endfor %}

	
</div>
{% endif %}

{% endblock content %}

{% block javascript %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
	return cookieValue;
}
//some ajax
// I hate this works but needs some heavy additions
function viewConditions(experiment_name){
	$.ajax({
        type: 'POST',
        url: "{% url 'view_conditions' %}",
        data: {"experiment_name":experiment_name},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var conditions = response["conditions"]
				// convert to JSON object
				var instance = JSON.parse(conditions);
				var id = "conditions_"+experiment_name;
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
                    `<button id = "condition_${fields["name"]}" value="${fields["name"]}" onclick="viewGames('${fields["name"]}')">${fields["name"]}</button><br>
					<div id = "games_${fields["name"]}"></div>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};

function viewGames(condition_name){
	$.ajax({
        type: 'POST',
        url: "{% url 'view_games' %}",
        data: {"condition_name":condition_name},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var games = response["games"]
				// convert to JSON object
				var instance = JSON.parse(games);
				var id = "games_"+condition_name;
				console.log(id);
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
					// ADD ONCLICK EVENT FOR CHATS/PLAYERS
                    `<button id = "game_${fields["room_name"]}" value="${fields["room_name"]}">${fields["room_name"]}</button><br>
					<div id = "chats_${fields["room_name"]}"></div>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
// need function to view chat conversations for each game
// frontend -> need to have a nice way to view all the data for each entry
</script>
{% endblock javascript %}