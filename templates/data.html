{% extends 'base.html' %}
{% load static %}
{% block title %}Game Data{% endblock %}
{% block content %}

{% comment %}
page so researchers can view data on games
{% endcomment %}

<style>
    /* styling for all buttons and when you expand it. I'll move it into home.css later */
    .button {
        color: white;
        background-color: #e0ac1c;
        font-size: 16px;
        cursor: pointer;
        margin: 5px;
        padding: 10px;
        border-radius: 10px;
        width: 80%;
        text-align: left;
        overflow: hidden;
        white-space: nowrap;
        border: none;
        text-overflow: ellipsis;
    }

    .button:hover { 
        color: white;
        background-color: black;
    }

    .button-expanded {
        background-color: #4d4d4d;
        color: white;
        border-radius: 10px;
        border: 2px solid #e0ac1c;
        padding: 20px;
        width: 80%;
        
    }

    .button-expanded p {
        margin: 0;
    }

    .experiment-row {
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        
    }

    .experiment-info {
        border-radius: 10px;
        border: 2px solid #e0ac1c;
        background-color: #2e2e2e;
        margin-top: 5px;
        padding: 10px;
        width: 80%;
        margin: 5px;
    }

    .experiment-description {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
    }
</style>

<div><p>click an experiment to see further information</p></div>

{% if experiments %}
<div id="viewConditions">
    {% for experiment in experiments %}
    <div class="experiment-row" id = "experiment_{{experiment}}">
            <button class="button" id="experiment_button{{experiment}}" 
                onclick="viewConditions('{{experiment}}')">
                {{ experiment }}
            </button>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block javascript %}
<script>
var current_researcher = "{{ researcher.researcher_id }}"
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
	return cookieValue;
}
//some ajax
function viewConditions(experiment_name){
    // functionality to expand and remove experimenet info
    var experimentButton = document.getElementById("experiment_button" + experiment_name);
    var experimentInfo = document.getElementById("conditions_" + experiment_name);
        if (experimentButton.classList.contains("button-expanded")) {
            experimentButton.classList.remove("button-expanded");
            experimentInfo.remove()
            return;
        } 
	$.ajax({
        type: 'POST',
        url: "{% url 'view_conditions' %}",
        data: {"experiment_name":experiment_name, "current_researcher": current_researcher},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
                // the conditions from the DB
				var conditions = response["conditions"]
                // the experiment from the DB
                var experiment = response["experiment"]
				// convert to JSON object
				var instance = JSON.parse(conditions);
                var instanceExperiment = JSON.parse(experiment)
                var fieldsExp = instance[0]["fields"]
                experimentId = "experiment_"+experiment_name
                var id = "conditions_"+experiment_name;
                $("#"+experimentId).append(
                    `<div class="experiment-info" id = "${id}"> <p>some info for experiment here, ${fieldsExp["active"]}, also some 
                        summarised data but that is heavy effort</p></div>`
                )
				for (let i = 0; i<instance.length; i++){
                    // fields for the conditions
					fields = instance[i]["fields"]
					$("#"+id).append(
                    `
                    <table>
                    </table>
                    <button class = "button" id = "condition_${fields["name"]}" 
                    value="${fields["name"]}" onclick="viewGames('${fields["name"]}', '${experiment_name}')">${fields["name"]}</button>
                    <div><p>The info for condition here ${fields["amount_item"]},${fields["active"]}</p></div>
					<div class = "experiment-info" style="display:none"
                    id = "games_${fields["name"]}_${experiment_name}"></div>`
                )
				}
                experimentButton.classList.add("button-expanded");
                //experimentInfo.style.display = "block";
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};

function viewGames(condition_name, experiment_name){
    var experimentButton = document.getElementById("condition_"+condition_name);
    var gameInfo = document.getElementById("games_"+condition_name+"_"+experiment_name)
    var experimentInfo = document.getElementById("games_sub_"+ condition_name + "_" + experiment_name);
        if (experimentButton.classList.contains("button-expanded")) {
            experimentButton.classList.remove("button-expanded");
            experimentInfo.remove()
            gameInfo.style.display = "none"
            return;
        }
	$.ajax({
        type: 'POST',
        url: "{% url 'view_games' %}",
        data: {"condition_name":condition_name,"experiment_name":experiment_name, "current_researcher":current_researcher},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
                gameInfo.style.display = "block"
				var games = response["games"]
				// convert to JSON object
				var instance = JSON.parse(games);
				var id = "games_"+condition_name+"_"+experiment_name;
                subId = "games_sub_"+condition_name+"_"+experiment_name
                $("#"+id).append(
                    `<div id = "${subId}"> </div>`
                )
                document.getElementById(id).style.display = "block"
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+subId).append(
					// ADD ONCLICK EVENT FOR CHATS/PLAYERS
                    `<button class = "button" id = "game_${fields["room_name"]}" value="${fields["room_name"]}" 
                    onclick="viewChats('${fields["room_name"]}')">${fields["room_name"]}</button>
                    <p> the info for the game here </p>
					<div class = "experiment-info" style="display:none"
                    id = "chats_${fields["room_name"]}"></div>`
                )
				}
                experimentButton.classList.add("button-expanded");
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
function viewChats(room_name){
    var experimentButton = document.getElementById("game_"+room_name);
    var gameInfo = document.getElementById("chats_"+room_name)
    var experimentInfo = document.getElementById("chats_sub_"+ room_name);
        if (experimentButton.classList.contains("button-expanded")) {
            experimentButton.classList.remove("button-expanded");
            experimentInfo.remove()
            gameInfo.style.display = "none"
            return;
        }
	$.ajax({
        type: 'POST',
        url: "{% url 'view_chats' %}",
        data: {"room_name":room_name},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var chats = response["chats"]
				// convert to JSON object
				var instance = JSON.parse(chats);
				var id = "chats_"+room_name;
                subId = "chats_sub_"+room_name
                $("#"+id).append(
                    `<div id = "${subId}"> </div>`
                )
                document.getElementById(id).style.display = "block"
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+subId).append(
                    `<p>${fields["role"]}: ${fields["content"]} -- ${fields["created"]}</p>`
                )
				}
                experimentButton.classList.add("button-expanded");
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
};
// frontend -> need to have a nice way to view all the data for each entry
</script>
{% endblock javascript %}