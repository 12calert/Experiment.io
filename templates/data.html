{% extends 'base.html' %}
{% load static %}
{% block title %}Game Data{% endblock %}
{% block content %}

{% comment %}
page so researchers can view data on games
{% endcomment %}

<div><p>click an experiment to see further information</p></div>

{# needs to change from form to something else #}
{% if experiments %}
<form id = "viewConditions" value="{{ experiment }}">
    {% csrf_token %}
	{% for experiment in experiments %}
    	<input id="experiment" type = "submit" value = "{{ experiment }}"/>
		{# figure something out here I hate this#}
		<div id = "conditions_{{experiment}}"></div>
	{% endfor %}

	
</form>
{% endif %}

{% comment %}
{% if experiments %}
	<table>
		<thead>
			<tr>
				<th>Experiment Name</th>
				<th>Active</th>
				<th>Conditions</th>
			</tr>
		</thead>
		<tbody>
			{% for experiment in experiments %}
				<tr> 
					<td>{{ experiment.name }}</td>
					<td>{{ experiment.active }}</td>

					{% if conditions %}
						<td>    
							<table>
								<thead>
									<tr>
										<th>Name</th>
										<th>Condition ID</th>
										<th>Amount of Items</th>
										<th>Special Restrictions</th>
										<th>Game Type</th>
										<th>Active</th>
									</tr>
								</thead>
								<tbody>
									{% for condition in conditions %}
										{% if condition.experiment == experiment %}
											<tr> 
												<td>{{ condition.name }}</td>
												<td>{{ condition.condition_id }}</td>
												<td>{{ condition.amount_item }}</td>
												<td>{{ condition.restriction }}</td>
												<td>{{ condition.game_type }}</td>
												<td>{{ condition.active}} </td>
											</tr>
										{% endif %}
									{% endfor %}
								</tbody>
							</table>
						</td>
					{% endif %}
				</tr>
			{% endfor %}
		</tbody>
	</table>
	{% endif %}

    {% if games %}
    <table>
		<thead>
			<tr>
				<th>Game ID</th>
				<th>Completed</th>
				<th>Game Type</th>
                <th>Chat Log</th>
			</tr>
		</thead>
		<tbody>
			{% for game in games %}
				<tr> 
					<td>{{ game.game }}</td>
					<td>{{ game.completed }}</td>
                    <td>{{ game.game_type }}</td>

					{% if chats %}
						<td>    
							<table>
								<thead>
									<tr>
										<th>Message</th>
										<th>Role</th>
										<th>Created</th>
									</tr>
								</thead>
								<tbody>
									{% for chat in chats %}
										{% if chat.game == game %}
											<tr> 
												<td>{{ chat.content }}</td>
												<td>{{ chat.role }}</td>
												<td>{{ chat.created }}</td>
											</tr>
										{% endif %}
									{% endfor %}
								</tbody>
							</table>
						</td>
					{% endif %}
				</tr>
			{% endfor %}
		</tbody>
	</table>
    {% endif %}
{% endcomment %}
    {% comment %}

	{% if conditions %}

	<table>
		<thead>
			<tr>
				<th>Condition ID</th>
				<th>Amount of Items</th>
				<th>Special Restrictions</th>
				<th>Game Type</th>
			</tr>
		</thead>
		<tbody>
			{% for condition in conditions %}
			<tr> 
				<td>{{ condition.condition_id }}</td>
				<td>{{ condition.amount_item }}</td>
				<td>{{ condition.restriction }}</td>
				<td>{{ condition.game_type }}</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
{% endif %}
{% endcomment %}
{% endblock content %}

{% block javascript %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
	return cookieValue;
}
//some ajax
// I hate this works but needs some heavy additions
$('#experiment').click(function(e){
	e.preventDefault();
	var experiment_name = $(this).attr('value');
	$.ajax({
        type: 'POST',
        url: "{% url 'view_conditions' %}",
        data: {"experiment_name":experiment_name},
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function (response) {
			// take the gathered query data and display
			if (response.exist){
				var conditions = response["conditions"]
				// convert to JSON object
				var instance = JSON.parse(conditions);
				var id = "conditions_"+experiment_name;
				console.log(id);
				for (let i = 0; i<instance.length; i++){
					fields = instance[i]["fields"]
					$("#"+id).append(
					// change this to something we can use
                    `${fields["name"]||""}<br>`
                )
				}
			}
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        }
    })
});
</script>
{% endblock javascript %}