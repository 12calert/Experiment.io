{% extends 'base.html' %}
{% load static %}
{% block title %}Game View{% endblock %}
{% block content %}

{# move this into css file or create a new css file for this page #}
<style>
.message   {
  font-weight: bold;
  color: #fff;
  background-color: #0084ff;
  border-radius: 10px;
  padding: 8px;
  margin-bottom: 10px;
  max-width: 100%;
  display: block;
}

.chat-log {
  max-height: 600px;
  overflow-y: scroll;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}
</style>
{# Collapsible "view information" #}
<div>
<button type="button" class="collapsible">View information</button>
<div class="content">
  <p>
    This game consits of 2 players, both randomly assigned to either a Giver/Follower.
    <br>This project was intented with researching how humans interact and try to guide each other with a disadvantage between each other.
    <br>Both players must interact with the chat box and try to figure out how to guide each other in order to get from the starting path to the end path.
    <br>It is recommended to explain each others maps at the start, and then go on from there, the Giver must pay attention to detail in order to guide the follower as much as they can.
  </p>
</div>
<div>
  your role is:
  {{player.role}}
  {% if player.role == "follower"%}
    you will receive instructions, etc.
  {% else %}
    you will give instructions to the follower, etc.
  {% endif %}
</div>
{# Game map and chat #}
<div class="row">
    <div class="col-sm-8 map"> <br><br><br><br><br><br><br><br>
        Photo of the Game map! (probably embeded)
    </div>
    <div class="col-sm-4 chat"><div id="chat-log" cols="100" rows="20"></div><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send">
    
    {# below turns python dict of room name into json to be used in script (see context variable in views.py) #}
    {{ room_name|json_script:"room-name" }}
    </div>

{# Buttons #}
<div class="col-sm-8">
  <button class="button button1">Complete</button>
  <button class="button button2">Give up</button>
</div>

{# Collapsible "view information" Javascript function #}
<script>
  // read the player's role from the Django template 
  var coll = document.getElementsByClassName("collapsible");
  var i;
    
  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
  }

  //read the current room name from context in views.py
  const roomName = JSON.parse(document.getElementById('room-name').textContent);

  //create new websocket for chat
  //let protocol = (window.location.protocol === 'https:' ? 'wss' : 'ws') + '://';
  const chatSocket = new WebSocket(
    // needs to be a wss connection to work over https
    "ws://"
    + window.location.host
    + '/ws/all_rooms/game_view/'
    + roomName
    + '/'
  );

  /* after every message, log it in a JSON chat log 
  ---         can be changed later     ---*/
  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    // Get the current time
    const time = new Date();
    const hours = time.getHours().toString().padStart(2, '0');
    const minutes = time.getMinutes().toString().padStart(2, '0');
    const formattedTime = hours + ':' + minutes;    
    // document.querySelector('#chat-log').value += (playerRole + ": " + data.message + '\n'); -> since we are no longer using a textarea this is not needed

    document.getElementById('chat-log').innerHTML += "<span class='message'>" + data.role +": "+ data.message +"<br></span>";

  };
 
  /* do something when the chat socket is closed */
  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  /* allows for submitting messages via pressing enter*/
  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {  // enter, return
        document.querySelector('#chat-message-submit').click();
    }
  };

  /* submitting messages sends messages via web socket*/
  document.querySelector('#chat-message-submit').onclick = function(e) {
    const messageInputDom = document.querySelector('#chat-message-input');
    const playerRole = "{{player.role}}";
    const message = messageInputDom.value;
    /* modify the message object to include the player's role */
    chatSocket.send(JSON.stringify({
        'message': message,
        'role': playerRole
    }));
    messageInputDom.value = '';
  };
  </script>
{% endblock %}